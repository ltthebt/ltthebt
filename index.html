<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„ç”µå­æ‰‹è´¦ (è‡ªåŠ¨ä¿å­˜ç‰ˆ)</title>
    <style>
        body {
            margin: 0;
            background-color: #fdf6e3;
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        /* å·¥å…·æ æ ·å¼ä¿æŒä¸å˜ */
        #toolbar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            z-index: 2000;
            width: 90%;
            max-width: 600px;
        }

        .tool-btn {
            border: none;
            background: #ffecd1;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tool-btn:hover {
            background: #ffd6a5;
            transform: scale(1.05);
        }
        
        #imageInput { display: none; }

        /* å…ƒç´ æ ·å¼ */
        .item {
            position: absolute;
            cursor: grab; 
            cursor: -webkit-grab;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        
        .item:active {
            cursor: grabbing;
            cursor: -webkit-grabbing;
        }

        .note {
            width: 150px;
            min-height: 150px;
            background: #fff740;
            padding: 15px;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.15);
            font-size: 16px;
            border-radius: 5px;
            word-break: break-all;
        }

        .sticker {
            font-size: 60px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .image-item img {
            max-width: 250px;
            max-height: 250px;
            border: 5px solid white;
            box-shadow: 3px 3px 12px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        
        /* åˆ é™¤æŒ‰é’®ï¼ˆé¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºï¼‰ */
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background: red;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            z-index: 1001;
        }
        
        /* åªæœ‰åœ¨ç”µè„‘ä¸Šé¼ æ ‡æ‚¬åœï¼Œæˆ–è€…é€‰ä¸­æ—¶æ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼Œç®€å•èµ·è§è¿™é‡Œåªåš hover */
        .item:hover .delete-btn {
            display: block;
        }

        @keyframes popIn {
            from { transform: scale(0) rotate(0); opacity: 0;}
            to { transform: scale(1) rotate(var(--rotation)); opacity: 1;}
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <button class="tool-btn" onclick="createNote()">ğŸ“ ä¾¿ç­¾</button>
        <button class="tool-btn" onclick="createEmoji()">ğŸ˜Š è¡¨æƒ…</button>
        <button class="tool-btn" onclick="document.getElementById('imageInput').click()">ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡</button>
        <button class="tool-btn" style="background:#ffcccb" onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
    </div>

    <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">

    <script>
        // --- æ ¸å¿ƒï¼šé¡µé¢åŠ è½½æ—¶ï¼Œè¯»å–è®°å¿† ---
        window.onload = function() {
            loadFromStorage();
        };

        // --- 1. åˆ›å»º/æ¢å¤ ä¾¿ç­¾ ---
        // å‚æ•° savedData æ˜¯ä¸ºäº†æ¢å¤æ•°æ®ç”¨çš„ï¼Œå¦‚æœæ˜¯æ–°å»ºåˆ™ä¸º undefined
        function createNote(savedData) {
            const note = document.createElement('div');
            note.className = 'item note';
            note.contentEditable = true; 
            
            // å¦‚æœæœ‰ä¿å­˜çš„æ•°æ®ï¼Œå°±ç”¨ä¿å­˜çš„ï¼›å¦åˆ™ç”¨é»˜è®¤å€¼
            note.innerText = savedData ? savedData.content : "ç‚¹æˆ‘å†™å­—...";
            
            setupElement(note, savedData); // è®¾ç½®ä½ç½®å’Œé€šç”¨åŠŸèƒ½
            
            // ç‰¹æ®ŠåŠŸèƒ½ï¼šä¾¿ç­¾å†…å®¹æ”¹å˜æ—¶ï¼Œä¹Ÿè¦ä¿å­˜
            note.addEventListener('input', saveData);

            document.body.appendChild(note);
            if (!savedData) saveData(); // å¦‚æœæ˜¯æ–°å»ºçš„ï¼Œç«‹åˆ»ä¿å­˜ä¸€æ¬¡
        }

        // --- 2. åˆ›å»º/æ¢å¤ è¡¨æƒ… ---
        function createEmoji(savedData) {
            const sticker = document.createElement('div');
            sticker.className = 'item sticker';
            
            if (savedData) {
                sticker.innerText = savedData.content;
            } else {
                const emojis = ['ğŸŒ¸', 'âœ¨', 'ğŸ‚', 'ğŸ±', 'ğŸ¶', 'ğŸ“·', 'ğŸ‰', 'ğŸŒ¿', 'ğŸ“', 'ğŸ§¸'];
                sticker.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            }
            
            setupElement(sticker, savedData);
            document.body.appendChild(sticker);
            if (!savedData) saveData();
        }
        
        // --- 3. å›¾ç‰‡ä¸Šä¼ ä¸æ¢å¤ ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                createImage(e.target.result); // æå–å‡ºåˆ›å»ºå›¾ç‰‡çš„é€»è¾‘
                event.target.value = ''; 
            };
            reader.readAsDataURL(file);
        }

        // ä¸“é—¨ç”¨æ¥åˆ›å»ºå›¾ç‰‡å…ƒç´ çš„å‡½æ•°ï¼ˆåˆ†ä¸ºæ–°å»ºå’Œæ¢å¤ä¸¤ç§æƒ…å†µï¼‰
        function createImage(src, savedData) {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'item image-item';
            
            const img = document.createElement('img');
            img.src = src;
            
            imgContainer.appendChild(img);
            setupElement(imgContainer, savedData);
            document.body.appendChild(imgContainer);
            
            // å›¾ç‰‡åŠ è½½æ¯”è¾ƒå¤§ï¼Œç¨å¾®å»¶è¿Ÿä¸€ç‚¹ä¿å­˜ï¼Œç¡®ä¿å›¾ç‰‡å‡ºæ¥äº†
            if(!savedData) setTimeout(saveData, 100); 
        }

        // --- é€šç”¨è®¾ç½®å‡½æ•°ï¼šç»™æ¯ä¸ªå…ƒç´ åŠ ä¸Šæ‹–æ‹½ã€ä½ç½®å’Œåˆ é™¤æŒ‰é’® ---
        function setupElement(element, savedData) {
            // 1. å®šä½
            if (savedData) {
                // å¦‚æœæ˜¯æ¢å¤æ¨¡å¼ï¼Œä½¿ç”¨ä¿å­˜çš„åæ ‡å’Œè§’åº¦
                element.style.left = savedData.left;
                element.style.top = savedData.top;
                element.style.transform = savedData.transform;
                // æŠŠè§’åº¦å­˜å›CSSå˜é‡ï¼Œæ–¹ä¾¿ä¸‹æ¬¡è¯»å–
                // è¿™é‡Œçš„æ­£åˆ™æå–æ˜¯ä¸ºäº†è®© transform rotate ä¹Ÿèƒ½æ­£ç¡®åœ¨CSSå˜é‡ä¸­è¿ä½œï¼ˆå¦‚æœéœ€è¦ï¼‰
            } else {
                // å¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œéšæœºæ”¾ç½®
                placeRandomly(element);
            }

            // 2. åŠ ä¸Šæ‹–æ‹½åŠŸèƒ½
            addDragFunction(element);

            // 3. åŠ ä¸Šåˆ é™¤å°çº¢ç‚¹ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
            const delBtn = document.createElement('div');
            delBtn.className = 'delete-btn';
            delBtn.innerText = 'Ã—';
            delBtn.onclick = function(e) {
                e.stopPropagation(); // é˜²æ­¢è§¦å‘æ‹–æ‹½
                if(confirm('åˆ é™¤è¿™ä¸ªå…ƒç´ ï¼Ÿ')) {
                    element.remove();
                    saveData(); // åˆ é™¤åä¿å­˜
                }
            };
            element.appendChild(delBtn);
        }

        function placeRandomly(element) {
            const rotation = Math.random() * 20 - 10; 
            const rotateStr = `rotate(${rotation}deg)`;
            element.style.transform = rotateStr;
            element.style.left = (window.innerWidth / 2 - 100 + Math.random() * 200) + 'px';
            element.style.top = (window.innerHeight / 2 - 100 + Math.random() * 200) + 'px';
        }

        // --- æ ¸å¿ƒé­”æ³• 1ï¼šä¿å­˜æ•°æ® (æ‹ç…§) ---
        function saveData() {
            const items = [];
            document.querySelectorAll('.item').forEach(el => {
                // åˆ¤æ–­ç±»å‹
                let type = 'sticker';
                let content = el.innerText.replace('Ã—', ''); // å»æ‰åˆ é™¤æŒ‰é’®çš„æ–‡å­—
                
                if (el.classList.contains('note')) {
                    type = 'note';
                } else if (el.classList.contains('image-item')) {
                    type = 'image';
                    content = el.querySelector('img').src; // å›¾ç‰‡å­˜çš„æ˜¯ Base64 ç¼–ç 
                }

                items.push({
                    type: type,
                    content: content,
                    left: el.style.left,
                    top: el.style.top,
                    transform: el.style.transform
                });
            });
            
            // æŠŠå¯¹è±¡æ•°ç»„å˜æˆå­—ç¬¦ä¸²ï¼Œå­˜å…¥æµè§ˆå™¨ LocalStorage
            localStorage.setItem('myHandyData', JSON.stringify(items));
        }

        // --- æ ¸å¿ƒé­”æ³• 2ï¼šè¯»å–æ•°æ® (è¿˜åŸ) ---
        function loadFromStorage() {
            const dataStr = localStorage.getItem('myHandyData');
            if (!dataStr) return; // å¦‚æœæ²¡æœ‰å­˜æ¡£ï¼Œå•¥ä¹Ÿä¸åš

            const items = JSON.parse(dataStr);
            items.forEach(item => {
                if (item.type === 'note') createNote(item);
                else if (item.type === 'sticker') createEmoji(item);
                else if (item.type === 'image') createImage(item.content, item);
            });
        }

        // æ¸…ç©ºç”»å¸ƒåŒæ—¶æ¸…ç©ºè®°å¿†
        function clearCanvas() {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')){
                document.querySelectorAll('.item').forEach(item => item.remove());
                localStorage.removeItem('myHandyData'); // åˆ æ‰å­˜æ¡£
            }
        }


        // --- æ‹–æ‹½åŠŸèƒ½ (ä¿æŒä¹‹å‰çš„é€»è¾‘ï¼ŒåªåŠ äº†ä¸€è¡Œ saveData) ---
        function addDragFunction(element) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            function getClientCoords(e) {
                if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                return { x: e.clientX, y: e.clientY };
            }

            function startDrag(e) {
                if (e.target.className === 'delete-btn') return; // ç‚¹åˆ é™¤æŒ‰é’®æ—¶ä¸æ‹–æ‹½
                if (element.isContentEditable && document.activeElement === element) return;
                
                isDragging = true;
                const coords = getClientCoords(e);
                startX = coords.x;
                startY = coords.y;
                initialLeft = element.offsetLeft;
                initialTop = element.offsetTop;
                
                element.style.zIndex = 9999;
                element.style.transition = 'none'; 
            }

            function doDrag(e) {
                if (!isDragging) return;
                if (e.cancelable) e.preventDefault(); 

                const coords = getClientCoords(e);
                const dx = coords.x - startX;
                const dy = coords.y - startY;
                element.style.left = `${initialLeft + dx}px`;
                element.style.top = `${initialTop + dy}px`;
            }

            function stopDrag() {
                if (isDragging) {
                    isDragging = false;
                    element.style.zIndex = ''; 
                    element.style.transition = 'all 0.2s';
                    
                    // é‡ç‚¹ï¼šæ‹–åŠ¨ç»“æŸåï¼Œä¿å­˜ä½ç½®ï¼
                    saveData();
                }
            }

            element.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
            element.addEventListener('touchstart', startDrag, {passive: false}); 
            document.addEventListener('touchmove', doDrag, {passive: false});
            document.addEventListener('touchend', stopDrag);
        }
    </script>
</body>
</html>

